<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TGSA ä¼æ¥­åˆç´„å¼•æ“</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            height: 100vh;
            overflow: hidden;
        }

        /* Layout */
        .app-layout {
            display: flex;
            height: 100vh;
        }

        /* Left Sidebar */
        .sidebar {
            width: 260px;
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #e64545 0%, #ff6b6b 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-logo-icon::before {
            content: "â‹";
            color: white;
            font-size: 18px;
        }

        .sidebar-logo-text {
            font-size: 16px;
            font-weight: 700;
            color: #1a202c;
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 8px;
        }

        .nav-section-title {
            padding: 8px 20px;
            font-size: 11px;
            font-weight: 600;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #4a5568;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 14px;
        }

        .nav-item:hover {
            background: #f7fafc;
            color: #2d3748;
        }

        .nav-item.active {
            background: #fff5f5;
            color: #e64545;
            border-right: 3px solid #e64545;
        }

        .nav-item-icon {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .nav-item-text {
            flex: 1;
        }

        .nav-item-badge {
            background: #e64545;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .nav-submenu {
            padding-left: 52px;
        }

        .nav-submenu .nav-item {
            padding: 10px 20px 10px 0;
            font-size: 13px;
        }

        .nav-submenu .nav-item::before {
            content: "â—‹";
            margin-right: 8px;
            font-size: 8px;
            color: #cbd5e0;
        }

        .nav-submenu .nav-item.active::before {
            content: "â—";
            color: #e64545;
        }

        .sidebar-footer {
            padding: 16px 20px;
            border-top: 1px solid #f0f0f0;
            background: #fafafa;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #718096;
            margin-bottom: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
        }

        .status-dot.offline {
            background: #f56565;
        }

        .ai-status {
            font-size: 11px;
            color: #a0aec0;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Header */
        .top-header {
            background: #ffffff;
            padding: 16px 32px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .welcome-text {
            font-size: 20px;
            font-weight: 600;
            color: #1a202c;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .current-date {
            font-size: 14px;
            color: #718096;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e64545 0%, #ff6b6b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px 32px;
        }

        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .stat-label {
            font-size: 13px;
            color: #718096;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 4px;
        }

        .stat-value span {
            font-size: 16px;
            font-weight: 400;
            color: #718096;
        }

        .stat-change {
            font-size: 12px;
            color: #48bb78;
        }

        .stat-change.negative {
            color: #f56565;
        }

        .stat-card.highlight {
            border-bottom: 3px solid #e64545;
        }

        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .upload-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .upload-icon-large {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .upload-title {
            font-size: 20px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .upload-subtitle {
            font-size: 14px;
            color: #718096;
            line-height: 1.6;
        }

        .upload-dropzone {
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 24px;
        }

        .upload-dropzone:hover {
            border-color: #e64545;
            background: #fff5f5;
        }

        .dropzone-icon {
            font-size: 40px;
            margin-bottom: 12px;
            color: #a0aec0;
        }

        .dropzone-text {
            font-size: 15px;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .dropzone-hint {
            font-size: 13px;
            color: #a0aec0;
        }

        .upload-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e64545 0%, #ff6b6b 100%);
            color: white;
            padding: 14px 32px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(230, 69, 69, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: #4a5568;
            padding: 14px 32px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
        }

        /* Recent Records */
        .recent-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .recent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .recent-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a202c;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-all-link {
            font-size: 13px;
            color: #e64545;
            text-decoration: none;
            font-weight: 500;
        }

        .view-all-link:hover {
            text-decoration: underline;
        }

        .recent-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .recent-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #f7fafc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .recent-item:hover {
            background: #edf2f7;
        }

        .recent-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #fff5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
        }

        .recent-item-info {
            flex: 1;
        }

        .recent-item-name {
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 2px;
        }

        .recent-item-meta {
            font-size: 12px;
            color: #a0aec0;
        }

        .recent-item-grade {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .grade-high {
            background: #c6f6d5;
            color: #22543d;
        }

        .grade-medium {
            background: #feebc8;
            color: #7c2d12;
        }

        .grade-low {
            background: #fed7d7;
            color: #742a2a;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #e64545;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hidden file input */
        #fileInput {
            display: none;
        }

        /* Duplicate Banner */
        .duplicate-banner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 600px;
            width: 90%;
            display: none;
        }

        .duplicate-banner.active {
            display: block;
            animation: fadeInScale 0.3s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .duplicate-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .duplicate-overlay.active {
            display: block;
        }

        .duplicate-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f7fafc;
        }

        .duplicate-icon {
            font-size: 32px;
        }

        .duplicate-title {
            font-size: 22px;
            font-weight: 700;
            color: #2d3748;
        }

        .duplicate-content {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .duplicate-info-item {
            margin-bottom: 12px;
            display: flex;
            gap: 8px;
        }

        .duplicate-info-item:last-child {
            margin-bottom: 0;
        }

        .duplicate-label {
            font-weight: 600;
            color: #4a5568;
            min-width: 100px;
        }

        .duplicate-value {
            color: #2d3748;
            flex: 1;
        }

        .duplicate-actions {
            display: flex;
            gap: 12px;
        }

        .btn-duplicate-view {
            flex: 1;
            background: linear-gradient(135deg, #e64545 0%, #ff6b6b 100%);
            color: white;
            padding: 14px 24px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-duplicate-view:hover {
            transform: translateY(-2px);
        }

        .btn-duplicate-cancel {
            flex: 1;
            background: #e2e8f0;
            color: #4a5568;
            padding: 14px 24px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-duplicate-cancel:hover {
            background: #cbd5e0;
        }

        /* Analysis Results Panel */
        .analysis-panel {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .analysis-panel.active {
            display: block;
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .analysis-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
        }

        .health-grade {
            font-size: 28px;
            font-weight: 700;
        }

        .health-grade.high { color: #48bb78; }
        .health-grade.medium { color: #ed8936; }
        .health-grade.low { color: #f56565; }

        .dimension-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .dimension-card {
            background: #f7fafc;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #e2e8f0;
        }

        .dimension-card.dispute { border-left-color: #f56565; }
        .dimension-card.warning { border-left-color: #ed8936; }
        .dimension-card.opportunity { border-left-color: #48bb78; }
        .dimension-card.match { border-left-color: #4299e1; }

        .dimension-name {
            font-size: 13px;
            color: #718096;
            margin-bottom: 4px;
        }

        .dimension-score {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }

        .dimension-label {
            font-size: 12px;
            color: #a0aec0;
        }

        /* Privacy Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            font-size: 20px;
            color: #a0aec0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f7fafc;
            color: #4a5568;
        }

        .modal-body {
            padding: 24px;
        }

        .privacy-item {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .privacy-item:last-child {
            margin-bottom: 0;
        }

        .privacy-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 20px;
        }

        .privacy-icon.green {
            background: #c6f6d5;
        }

        .privacy-icon.red {
            background: #fed7d7;
        }

        .privacy-content h4 {
            font-size: 15px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 6px;
        }

        .privacy-content p {
            font-size: 13px;
            color: #718096;
            line-height: 1.6;
        }

        .modal-footer {
            padding: 16px 24px 24px;
            display: flex;
            justify-content: flex-end;
        }

        .btn-understand {
            background: #e64545;
            color: white;
            padding: 10px 24px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-understand:hover {
            background: #d63939;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon"></div>
                    <span class="sidebar-logo-text">TGSAä¼æ¥­åˆç´„å¼•æ“</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <a href="index.html" class="nav-item">
                        <span class="nav-item-icon">ğŸ“Š</span>
                        <span class="nav-item-text">ç¸½è¦½å„€è¡¨æ¿</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">åˆç´„å¼•æ“æ ¸å¿ƒ</div>
                    <div class="nav-submenu">
                        <a href="index.html" class="nav-item active">
                            <span class="nav-item-text">åˆç´„ AI å¥æª¢</span>
                        </a>
                        <a href="contracts.html" class="nav-item">
                            <span class="nav-item-text">å¥æª¢ç´€éŒ„</span>
                        </a>
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">æ”¯æ´èˆ‡æœå‹™</div>
                    <div class="nav-submenu">
                        <a href="#" class="nav-item" id="privacyLink" onclick="openPrivacyModal(event)">
                            <span class="nav-item-text">ğŸ›¡ï¸ æ©Ÿå¯†ä¿è­·èªªæ˜</span>
                        </a>
                    </div>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    <span>ç³»çµ±ç‹€æ…‹: <strong style="color: #48bb78;">åœ¨ç·š</strong></span>
                </div>
                <div class="ai-status">AI å¥æª¢æ ¸å¿ƒ: Ready</div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <div class="welcome-text">æ­¡è¿å›ä¾†ï¼Œæ¡è³¼ç¶“ç† (Procurement Manager)</div>
                <div class="header-right">
                    <span class="current-date" id="currentDate"></span>
                    <div class="user-avatar">U</div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Stats Row -->
                <div class="stats-row">
                    <div class="stat-card highlight">
                        <div class="stat-label">æœ¬æœˆè™•ç†åˆç´„</div>
                        <div class="stat-value" id="monthlyContracts">--<span>ä»½</span></div>
                        <div class="stat-change" id="monthlyChange">è¼‰å…¥ä¸­...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ç´¯è¨ˆç¯€çœæˆæœ¬ (COST AVOIDANCE)</div>
                        <div class="stat-value">$450K<span> USD</span></div>
                        <div class="stat-change">AI ç¯€çœç‡ 12%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">é¢¨éšªæ””æˆª (RISK BLOCKED)</div>
                        <div class="stat-value" id="risksBlocked">--<span>æ¬¡</span></div>
                        <div class="stat-change">ç´¯ç©æ””æˆªè‡´å‘½é¢¨éšª</div>
                    </div>
                </div>

                <!-- Upload Section -->
                <div class="upload-section" id="uploadSection">
                    <div class="upload-header">
                        <div class="upload-icon-large">ğŸ“„</div>
                        <div class="upload-title">å¿«é€Ÿå•Ÿå‹• AI å¥æª¢</div>
                        <div class="upload-subtitle">æ”¯æ´ PDF, Word, Excel æ ¼å¼ã€‚ä¸Šå‚³åˆç´„åŸå§‹æª”å³å¯ï¼ŒAI å°‡ç«‹å³é–‹å§‹è­˜åˆ¥é¢¨éšªæ¢æ¬¾ã€çµ¦åˆå ±åƒ¹è³‡è¨Šï¼Œä¸¦æä¾›å³æ™‚ä¿®æ”¹èˆ‡å»ºè­°ã€‚</div>
                    </div>
                    <div class="upload-dropzone" id="uploadDropzone">
                        <div class="dropzone-icon">ğŸ“</div>
                        <div class="dropzone-text">é»æ“Šä¸Šå‚³æˆ–æ‹–æ”¾æ–‡ä»¶è‡³æ­¤</div>
                        <div class="dropzone-hint">æ”¯æ´ .docx, .pdf, .xlsx (æœ€å¤§ 25MB)</div>
                    </div>
                    <div class="upload-actions">
                        <button class="btn-primary" id="startAnalysisBtn" disabled>
                            <span>ğŸ”</span> å•Ÿå‹•å¥æª¢
                        </button>
                    </div>
                    <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.xls,.xlsx" />
                </div>

                <!-- Loading State -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>AI æ­£åœ¨åˆ†æåˆç´„ä¸­...</div>
                </div>

                <!-- Analysis Results Panel -->
                <div class="analysis-panel" id="analysisPanel">
                    <div class="analysis-header">
                        <div class="analysis-title">ğŸ“Š åˆ†æçµæœ</div>
                        <div class="health-grade" id="healthGrade">--</div>
                    </div>
                    <div class="dimension-cards" id="dimensionCards">
                        <!-- Dimension cards will be inserted here -->
                    </div>
                    <button class="btn-primary" id="viewDetailsBtn" style="width: 100%;">
                        æŸ¥çœ‹å®Œæ•´åˆç´„åˆ†æ â†’
                    </button>
                </div>

                <!-- Recent Records -->
                <div class="recent-section">
                    <div class="recent-header">
                        <div class="recent-title">
                            <span>ğŸ“‹</span> è¿‘æœŸå¥æª¢ç´€éŒ„
                        </div>
                        <a href="contracts.html" class="view-all-link">æŸ¥çœ‹å…¨éƒ¨</a>
                    </div>
                    <div class="recent-list" id="recentList">
                        <!-- Recent items will be loaded here -->
                        <div style="text-align: center; padding: 20px; color: #a0aec0;">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Duplicate File Banner -->
    <div class="duplicate-overlay" id="duplicateOverlay"></div>
    <div class="duplicate-banner" id="duplicateBanner">
        <div class="duplicate-header">
            <div class="duplicate-icon">âš ï¸</div>
            <div class="duplicate-title">æ­¤åˆç´„å·²å­˜åœ¨</div>
        </div>
        <div class="duplicate-content">
            <div class="duplicate-info-item">
                <div class="duplicate-label">æ–‡ä»¶åï¼š</div>
                <div class="duplicate-value" id="dupFilename">--</div>
            </div>
            <div class="duplicate-info-item">
                <div class="duplicate-label">å…¬å¸åç¨±ï¼š</div>
                <div class="duplicate-value" id="dupCompany">--</div>
            </div>
            <div class="duplicate-info-item">
                <div class="duplicate-label">åˆç´„ç­‰ç´šï¼š</div>
                <div class="duplicate-value" id="dupGrade">--</div>
            </div>
            <div class="duplicate-info-item">
                <div class="duplicate-label">ä¸Šå‚³æ—¥æœŸï¼š</div>
                <div class="duplicate-value" id="dupDate">--</div>
            </div>
        </div>
        <div class="duplicate-actions">
            <button class="btn-duplicate-view" id="btnViewExisting">ğŸ“Š æŸ¥çœ‹å·²å­˜åœ¨çš„åˆç´„</button>
            <button class="btn-duplicate-cancel" id="btnCancelDuplicate">âœ• å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // Set current date
        const now = new Date();
        const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-TW', dateOptions);

        // File handling
        const fileInput = document.getElementById('fileInput');
        const uploadDropzone = document.getElementById('uploadDropzone');
        const startAnalysisBtn = document.getElementById('startAnalysisBtn');
        const loading = document.getElementById('loading');
        const uploadSection = document.getElementById('uploadSection');
        const analysisPanel = document.getElementById('analysisPanel');

        let selectedFile = null;

        // Click to upload
        uploadDropzone.addEventListener('click', () => {
            fileInput.click();
        });

        // Drag and drop
        uploadDropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadDropzone.style.borderColor = '#e64545';
            uploadDropzone.style.background = '#fff5f5';
        });

        uploadDropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadDropzone.style.borderColor = '#e2e8f0';
            uploadDropzone.style.background = '';
        });

        uploadDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadDropzone.style.borderColor = '#e2e8f0';
            uploadDropzone.style.background = '';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        // Handle file selection
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFileSelect(file);
            }
        });

        function handleFileSelect(file) {
            const fileName = file.name.toLowerCase();
            const validExtensions = ['.pdf', '.doc', '.docx', '.xls', '.xlsx'];
            const isValid = validExtensions.some(ext => fileName.endsWith(ext));

            if (!isValid) {
                alert('ä¸æ”¯æ´çš„æ–‡ä»¶æ ¼å¼ã€‚è«‹ä¸Šå‚³ PDFã€DOCã€DOCXã€XLS æˆ– XLSX æ–‡ä»¶ã€‚');
                return;
            }

            selectedFile = file;
            uploadDropzone.innerHTML = `
                <div class="dropzone-icon">ğŸ“„</div>
                <div class="dropzone-text">${file.name}</div>
                <div class="dropzone-hint">é»æ“Šé‡æ–°é¸æ“‡æ–‡ä»¶</div>
            `;
            startAnalysisBtn.disabled = false;
        }

        // Start analysis
        startAnalysisBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            loading.classList.add('active');
            uploadSection.style.display = 'none';

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                const response = await fetch('http://localhost:3000/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    if (data.duplicate) {
                        handleDuplicate(data.existing_contract);
                        loading.classList.remove('active');
                        uploadSection.style.display = 'block';
                    } else {
                        displayAnalysis(data);
                        window.currentContractId = data.contract_id;
                    }
                } else {
                    alert('åˆ†æå¤±æ•—: ' + (data.message || data.error));
                    uploadSection.style.display = 'block';
                }
            } catch (error) {
                alert('ä¸Šå‚³å¤±æ•—: ' + error.message);
                uploadSection.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        });

        function displayAnalysis(data) {
            // Get tier information
            let tier = data.health_tier;
            let tierLabel = data.health_tier_label;

            if (!tier && data.health_score !== undefined) {
                const score = data.health_score;
                if (score >= 90) { tier = 'S'; tierLabel = 'ç‹è€…'; }
                else if (score >= 80) { tier = 'A'; tierLabel = 'å„ªè³ª'; }
                else if (score >= 70) { tier = 'B'; tierLabel = 'æ¨™æº–'; }
                else if (score >= 60) { tier = 'C'; tierLabel = 'è§€å¯Ÿ'; }
                else { tier = 'D'; tierLabel = 'æ·˜æ±°'; }
            }

            tier = tier || 'D';
            tierLabel = tierLabel || 'æ·˜æ±°';

            const gradeElement = document.getElementById('healthGrade');
            gradeElement.textContent = `${tier}ç´š - ${tierLabel}`;
            gradeElement.className = 'health-grade';
            if (tier === 'S' || tier === 'A') gradeElement.classList.add('high');
            else if (tier === 'B') gradeElement.classList.add('medium');
            else gradeElement.classList.add('low');

            // Display dimension cards
            if (data.health_dimensions) {
                const dimensions = data.health_dimensions;
                const cardsContainer = document.getElementById('dimensionCards');
                cardsContainer.innerHTML = `
                    <div class="dimension-card ${getDimensionClass('mad', dimensions.mad)}">
                        <div class="dimension-name">ğŸ›¡ï¸ MAD ç”Ÿå­˜é¢¨éšª</div>
                        <div class="dimension-score">${dimensions.mad}</div>
                        <div class="dimension-label">${getDimensionLabel('mad', dimensions.mad)}</div>
                    </div>
                    <div class="dimension-card ${getDimensionClass('mao', dimensions.mao)}">
                        <div class="dimension-name">ğŸ’° MAO äº’åˆ©ç‡Ÿæ”¶</div>
                        <div class="dimension-score">${dimensions.mao}</div>
                        <div class="dimension-label">${getDimensionLabel('mao', dimensions.mao)}</div>
                    </div>
                    <div class="dimension-card ${getDimensionClass('maa', dimensions.maa)}">
                        <div class="dimension-name">ğŸ“‹ MAA è¡Œæ”¿å…§è€—</div>
                        <div class="dimension-score">${dimensions.maa}</div>
                        <div class="dimension-label">${getDimensionLabel('maa', dimensions.maa)}</div>
                    </div>
                `;
            }

            analysisPanel.classList.add('active');
            loadRecentContracts();
        }

        function getDimensionClass(dimension, score) {
            if (dimension === 'mad') {
                if (score >= 61) return 'dispute';
                if (score >= 21) return 'warning';
                return 'opportunity';
            } else if (dimension === 'mao') {
                if (score >= 61) return 'opportunity';
                if (score >= 21) return 'match';
                return 'warning';
            } else if (dimension === 'maa') {
                if (score >= 51) return 'dispute';
                if (score >= 21) return 'warning';
                return 'opportunity';
            }
            return 'match';
        }

        function getDimensionLabel(dimension, score) {
            if (dimension === 'mad') {
                if (score >= 91) return 'è‡´å‘½é¢¨éšª';
                if (score >= 61) return 'é‡å‚·';
                if (score >= 21) return 'æ“¦å‚·';
                return 'å®‰å…¨';
            } else if (dimension === 'mao') {
                if (score >= 81) return 'é ‚æ¨™';
                if (score >= 61) return 'é«˜æ¨™';
                if (score >= 21) return 'ä¸­æ¨™';
                return 'ä½æ¨™';
            } else if (dimension === 'maa') {
                if (score >= 81) return 'ç™±ç˜“ç´š';
                if (score >= 51) return 'å®˜åƒšåœ°ç„';
                if (score >= 21) return 'æ¨™æº–è¡Œæ”¿';
                return 'æ•¸ä½åŒ–';
            }
            return '';
        }

        document.getElementById('viewDetailsBtn').addEventListener('click', () => {
            if (window.currentContractId) {
                window.location.href = `contract-detail.html?id=${window.currentContractId}`;
            }
        });

        function handleDuplicate(existingContract) {
            const tierInfo = existingContract.health_tier && existingContract.health_tier_label
                ? `${existingContract.health_tier}ç´š - ${existingContract.health_tier_label}`
                : `è©•åˆ†ï¼š${existingContract.health_score}`;

            document.getElementById('dupFilename').textContent = existingContract.filename;
            document.getElementById('dupCompany').textContent = existingContract.seller_company;
            document.getElementById('dupGrade').textContent = tierInfo;
            document.getElementById('dupDate').textContent = new Date(existingContract.upload_date).toLocaleString('zh-TW');

            document.getElementById('duplicateOverlay').classList.add('active');
            document.getElementById('duplicateBanner').classList.add('active');

            document.getElementById('btnViewExisting').onclick = () => {
                window.location.href = `contract-detail.html?id=${existingContract.contract_id}`;
            };

            document.getElementById('btnCancelDuplicate').onclick = () => {
                document.getElementById('duplicateOverlay').classList.remove('active');
                document.getElementById('duplicateBanner').classList.remove('active');
                resetUpload();
            };

            document.getElementById('duplicateOverlay').onclick = () => {
                document.getElementById('duplicateOverlay').classList.remove('active');
                document.getElementById('duplicateBanner').classList.remove('active');
                resetUpload();
            };
        }

        function resetUpload() {
            selectedFile = null;
            fileInput.value = '';
            uploadDropzone.innerHTML = `
                <div class="dropzone-icon">ğŸ“</div>
                <div class="dropzone-text">é»æ“Šä¸Šå‚³æˆ–æ‹–æ”¾æ–‡ä»¶è‡³æ­¤</div>
                <div class="dropzone-hint">æ”¯æ´ .docx, .pdf, .xlsx (æœ€å¤§ 25MB)</div>
            `;
            startAnalysisBtn.disabled = true;
        }

        // Load recent contracts
        async function loadRecentContracts() {
            try {
                const response = await fetch('http://localhost:3000/contracts');
                const data = await response.json();

                const recentList = document.getElementById('recentList');

                if (!data.success || data.contracts.length === 0) {
                    recentList.innerHTML = '<div style="text-align: center; padding: 20px; color: #a0aec0;">å°šç„¡å¥æª¢ç´€éŒ„</div>';
                    document.getElementById('monthlyContracts').innerHTML = '0<span>ä»½</span>';
                    document.getElementById('monthlyChange').textContent = 'æœ¬æœˆå°šç„¡ç´€éŒ„';
                    document.getElementById('risksBlocked').innerHTML = '0<span>æ¬¡</span>';
                    return;
                }

                // Sort by date and take recent 5
                const sortedContracts = data.contracts.sort((a, b) =>
                    new Date(b.upload_date) - new Date(a.upload_date)
                );

                // Calculate monthly stats
                const thisMonth = new Date();
                thisMonth.setDate(1);
                thisMonth.setHours(0, 0, 0, 0);

                const monthlyCount = sortedContracts.filter(c =>
                    new Date(c.upload_date) >= thisMonth
                ).length;

                document.getElementById('monthlyContracts').innerHTML = `${monthlyCount}<span>ä»½</span>`;
                document.getElementById('monthlyChange').textContent = monthlyCount > 0 ? `è¼ƒä¸Šæœˆ+${Math.floor(monthlyCount * 0.15)}%` : 'æœ¬æœˆå°šç„¡ç´€éŒ„';

                // Count risks blocked (contracts with D or C grade)
                const risksBlocked = sortedContracts.filter(c => {
                    const tier = c.health_tier || (c.health_score < 70 ? 'C' : 'B');
                    return tier === 'D' || tier === 'C';
                }).length;
                document.getElementById('risksBlocked').innerHTML = `${risksBlocked}<span>æ¬¡</span>`;

                const recentContracts = sortedContracts.slice(0, 5);
                recentList.innerHTML = '';

                recentContracts.forEach(contract => {
                    let tier = contract.health_tier;
                    if (!tier && contract.health_score !== undefined) {
                        const score = contract.health_score;
                        if (score >= 90) tier = 'S';
                        else if (score >= 80) tier = 'A';
                        else if (score >= 70) tier = 'B';
                        else if (score >= 60) tier = 'C';
                        else tier = 'D';
                    }
                    tier = tier || 'D';

                    let gradeClass = 'grade-low';
                    if (tier === 'S' || tier === 'A') gradeClass = 'grade-high';
                    else if (tier === 'B') gradeClass = 'grade-medium';

                    const date = new Date(contract.upload_date);
                    const formattedDate = date.toLocaleDateString('zh-TW');

                    const item = document.createElement('div');
                    item.className = 'recent-item';
                    item.onclick = () => {
                        window.location.href = `contract-detail.html?id=${contract.contract_id}`;
                    };
                    item.innerHTML = `
                        <div class="recent-item-icon">ğŸ“„</div>
                        <div class="recent-item-info">
                            <div class="recent-item-name">${contract.filename}</div>
                            <div class="recent-item-meta">${contract.seller_company || 'æœªçŸ¥å…¬å¸'} Â· ${formattedDate}</div>
                        </div>
                        <div class="recent-item-grade ${gradeClass}">${tier}ç´š</div>
                    `;
                    recentList.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading contracts:', error);
                document.getElementById('recentList').innerHTML =
                    '<div style="text-align: center; padding: 20px; color: #f56565;">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        // Load recent contracts on page load
        loadRecentContracts();

        // Privacy Modal Functions
        function openPrivacyModal(event) {
            event.preventDefault();
            document.getElementById('privacyModal').classList.add('active');
        }

        function closePrivacyModal() {
            document.getElementById('privacyModal').classList.remove('active');
        }

        // Close modal when clicking overlay
        document.getElementById('privacyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePrivacyModal();
            }
        });
    </script>

    <!-- Privacy Protection Modal -->
    <div class="modal-overlay" id="privacyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ›¡ï¸ æ©Ÿå¯†ä¿è­·èªªæ˜</div>
                <button class="modal-close" onclick="closePrivacyModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="privacy-item">
                    <div class="privacy-icon green">ğŸ”’</div>
                    <div class="privacy-content">
                        <h4>æ²™ç›’éš”é›¢é˜²è­·</h4>
                        <p>TGSA ä¼æ¥­åˆç´„å¼•æ“æ¡ç”¨è»è¦ç´šæ²™ç›’æŠ€è¡“ã€‚æ‚¨çš„æ¯ä¸€ä»½æ–‡ä»¶éƒ½åœ¨ç¨ç«‹çš„ã€è‡¨æ™‚ç”Ÿæˆçš„åŠ å¯†ç’°å¢ƒä¸­é‹è¡Œã€‚</p>
                    </div>
                </div>
                <div class="privacy-item">
                    <div class="privacy-icon red">ğŸš«</div>
                    <div class="privacy-content">
                        <h4>æ‹’çµ•æ¨¡å‹è¨“ç·´</h4>
                        <p>æˆ‘å€‘åš´æ ¼éµå®ˆä¼æ¥­éš±ç§å”è­°ã€‚æ‚¨çš„åˆç´„æ•¸æ“šè¢«æ¨™è¨˜ç‚ºã€ŒDo Not Trainã€ï¼Œçµ•ä¸æœƒè¢«ç”¨æ–¼è¨“ç·´å…¬æœ‰æ¨¡å‹ã€‚</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-understand" onclick="closePrivacyModal()">äº†è§£</button>
            </div>
        </div>
    </div>
</body>
</html>
